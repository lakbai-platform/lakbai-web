// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider  = "postgresql"
}

model User {
  id             String         @id @default(cuid())
  email          String         @unique
  name           String?
  avatarUrl      String?

  reviews        POIReview[]
  vouches        POIVouch[]
  favorites      POIFavorite[]

  createdAt      DateTime       @default(now())
}

model POI {
  id               String         @id @default(cuid())
  name             String
  description      String         @db.Text
  latitude         Float          
  longitude        Float          
  operatingHours   String?        
  vouchCount       Int            @default(0) 
  
  // Relations
  tags             POITag[]       // <--- Many-to-many relation for tags/themes
  galleries        POIGallery[]
  reviews          POIReview[]
  vouches          POIVouch[]
  favorites        POIFavorite[]

  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
}

model POITag {
  id        String   @id @default(cuid())
  name      String   @unique // e.g., "Park", "Restaurant", "Hotel"
  pois      POI[]    // <--- Many-to-many relation back to POI
}

model POIGallery {
  id        String   @id @default(cuid())
  poiId     String
  poi       POI      @relation(fields: [poiId], references: [id], onDelete: Cascade)
  imageUrl  String   
  caption   String?

  createdAt DateTime @default(now())
}

model POIReview {
  id        String   @id @default(cuid())
  poiId     String
  poi       POI      @relation(fields: [poiId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  rating    Int      
  content   String   @db.Text

  history   POIReviewHistory[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model POIReviewHistory {
  id               String    @id @default(cuid())
  reviewId         String
  review           POIReview @relation(fields: [reviewId], references: [id], onDelete: Cascade)
  
  previousContent  String    @db.Text
  previousRating   Int
  
  changedAt        DateTime  @default(now())
}

model POIVouch {
  id        String   @id @default(cuid())
  poiId     String
  poi       POI      @relation(fields: [poiId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([poiId, userId]) 
}

model POIFavorite {
  id        String   @id @default(cuid())
  poiId     String
  poi       POI      @relation(fields: [poiId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([poiId, userId]) 
}
